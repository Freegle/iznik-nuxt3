default_platform(:android)

VERSION_FILE = "../VERSION.txt"

platform :android do
  desc "Build and deploy to Google Play Internal Testing"
  lane :internal do
    version = File.read(VERSION_FILE).strip

    # Set version name in build.gradle
    android_set_version_name(
      version_name: version,
      gradle_file: "android/app/build.gradle"
    )

    # Get latest build number from Play Console and increment
    latest_build = google_play_track_version_codes(
      track: 'internal',
      json_key: 'fastlane/google-play-api-key.json'
    ).first || 0

    android_set_version_code(
      version_code: latest_build + 1,
      gradle_file: "android/app/build.gradle"
    )

    # Build the Android App Bundle (AAB)
    gradle(
      task: 'bundle',
      build_type: 'Release',
      project_dir: 'android/'
    )

    # Upload to Google Play Internal Testing track
    upload_to_play_store(
      track: 'internal',
      json_key: 'fastlane/google-play-api-key.json',
      skip_upload_apk: true,
      skip_upload_metadata: true,
      skip_upload_images: true,
      skip_upload_screenshots: true
    )
  end

  desc "Promote Internal to Beta"
  lane :promote_beta do
    upload_to_play_store(
      track: 'internal',
      track_promote_to: 'beta',
      json_key: 'fastlane/google-play-api-key.json',
      skip_upload_apk: true,
      skip_upload_aab: true
    )
  end

  desc "Promote Beta to Production"
  lane :promote_production do
    upload_to_play_store(
      track: 'beta',
      track_promote_to: 'production',
      json_key: 'fastlane/google-play-api-key.json',
      skip_upload_apk: true,
      skip_upload_aab: true
    )
  end
end
