default_platform(:android)

VERSION_FILE = "../VERSION.txt"

platform :android do
  desc "Build and deploy to Google Play Internal Testing"
  lane :internal do
    # Get highest version name from ALL Google Play tracks
    current_version_name = nil
    begin
      require 'googleauth'
      require 'google/apis/androidpublisher_v3'

      json_key_data = JSON.parse(File.read('fastlane/google-play-api-key.json'))
      credentials = Google::Auth::ServiceAccountCredentials.make_creds(
        json_key_io: StringIO.new(json_key_data.to_json),
        scope: 'https://www.googleapis.com/auth/androidpublisher'
      )

      service = Google::Apis::AndroidpublisherV3::AndroidPublisherService.new
      service.authorization = credentials

      # Get the edit
      edit = service.insert_edit('org.ilovefreegle.direct')
      edit_id = edit.id

      # Check all tracks: production, beta (Open Testing), alpha, internal
      tracks = ['production', 'beta', 'alpha', 'internal']
      all_version_names = []

      tracks.each do |track_name|
        begin
          track_release = service.get_edit_track('org.ilovefreegle.direct', edit_id, track_name)

          if track_release.releases && track_release.releases.any?
            latest_release = track_release.releases.first
            if latest_release.version_codes && latest_release.version_codes.any?
              version_code = latest_release.version_codes.first
              apk = service.list_edit_apks('org.ilovefreegle.direct', edit_id).apks.find { |a| a.version_code == version_code }
              if apk && apk.version_name
                all_version_names << apk.version_name
                UI.message("ðŸ“Š Found version #{apk.version_name} in #{track_name} track")
              end
            end
          end
        rescue => track_error
          UI.message("â„¹ï¸  No releases in #{track_name} track")
        end
      end

      # Find the highest version across all tracks
      if all_version_names.any?
        current_version_name = all_version_names.max_by { |v| v.split('.').map(&:to_i) }
        UI.success("ðŸŽ¯ Highest version across all tracks: #{current_version_name}")
      end

      # Clean up the edit
      service.delete_edit('org.ilovefreegle.direct', edit_id)
    rescue => e
      UI.important("âš ï¸  Could not fetch version names from Play Console: #{e.message}")
    end

    # Auto-increment version name
    if current_version_name
      # Parse version (e.g., "3.2.27" -> [3, 2, 27])
      parts = current_version_name.split('.').map(&:to_i)

      if parts.length == 3
        # Increment patch version
        parts[2] += 1
        version = parts.join('.')
        UI.success("ðŸ“± Auto-incremented version name: #{current_version_name} â†’ #{version}")
      else
        # Fallback to VERSION.txt if version format is unexpected
        version = File.read(VERSION_FILE).strip
        UI.important("âš ï¸  Unexpected version format '#{current_version_name}', using VERSION.txt: #{version}")
      end
    else
      # Fallback to VERSION.txt if API call failed
      version = File.read(VERSION_FILE).strip
      UI.important("ðŸ“„ Using version from VERSION.txt: #{version}")
    end

    # Get version code - try Google Play API first, fallback to incremental
    begin
      # Try to get version codes from internal track first (where we upload to)
      version_codes = google_play_track_version_codes(
        track: 'internal',
        json_key: 'fastlane/google-play-api-key.json'
      )

      if version_codes && version_codes.any?
        latest_build = version_codes.first
        new_version_code = latest_build + 1
        UI.message("ðŸ“Š Using Play Console internal version code: #{latest_build}")
        UI.message("ðŸ“Š New version code: #{new_version_code}")
      else
        # Fall back to production track if internal is empty
        version_codes = google_play_track_version_codes(
          track: 'production',
          json_key: 'fastlane/google-play-api-key.json'
        )

        if version_codes && version_codes.any?
          latest_build = version_codes.first
          new_version_code = latest_build + 1
          UI.message("ðŸ“Š Using Play Console production version code: #{latest_build}")
          UI.message("ðŸ“Š New version code: #{new_version_code}")
        else
          # No releases on any track - use default
          new_version_code = 1297
          UI.important("âš ï¸  No releases found on any track")
          UI.important("ðŸ“… Using default version code: #{new_version_code}")
        end
      end
    rescue => e
      # Fallback: start from safe default
      new_version_code = 1297
      UI.important("âš ï¸  Google Play API error: #{e.message}")
      UI.important("ðŸ“… Using fallback version code: #{new_version_code}")
      UI.important("ðŸ’¡ Check service account permissions in Play Console")
    end

    # Build the Android App Bundle (AAB) for Play Store
    gradle(
      task: 'bundle',
      build_type: 'Release',
      project_dir: 'android/',
      properties: {
        "versionName" => version,
        "versionCode" => new_version_code.to_s
      },
      flags: '--stacktrace'  # Enable stack traces for debugging
    )

    # Also build APK for direct installation and testing
    gradle(
      task: 'assemble',
      build_type: 'Release',
      project_dir: 'android/',
      properties: {
        "versionName" => version,
        "versionCode" => new_version_code.to_s
      },
      flags: '--stacktrace'  # Enable stack traces for debugging
    )
    UI.success("âœ… APK built successfully for manual installation!")
    UI.message("ðŸ“± APK location: android/app/build/outputs/apk/release/app-release.apk")

    # Upload to Google Play Internal Testing track
    upload_to_play_store(
      track: 'internal',
      json_key: 'fastlane/google-play-api-key.json',
      skip_upload_apk: true,
      skip_upload_metadata: true,
      skip_upload_images: true,
      skip_upload_screenshots: true
    )
    UI.success("âœ… Successfully uploaded to Google Play Internal Testing!")
  end

  desc "Promote Internal to Beta"
  lane :promote_beta do
    upload_to_play_store(
      track: 'internal',
      track_promote_to: 'beta',
      json_key: 'fastlane/google-play-api-key.json',
      skip_upload_apk: true,
      skip_upload_aab: true
    )
  end

  desc "Promote Beta to Production"
  lane :promote_production do
    upload_to_play_store(
      track: 'beta',
      track_promote_to: 'production',
      json_key: 'fastlane/google-play-api-key.json',
      skip_upload_apk: true,
      skip_upload_aab: true
    )
  end
end
