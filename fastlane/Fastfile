default_platform(:android)

VERSION_FILE = "../VERSION.txt"

platform :android do
  desc "Build and deploy to Google Play Internal Testing"
  lane :internal do
    version = File.read(VERSION_FILE).strip

    # Get version code - try Google Play API first, fallback to timestamp
    begin
      latest_build = google_play_track_version_codes(
        track: 'internal',
        json_key: 'fastlane/google-play-api-key.json'
      ).first || 0
      new_version_code = latest_build + 1
      UI.message("üìä Using Play Console version code: #{new_version_code}")
    rescue => e
      # Fallback: use timestamp-based version code (YYMMDDHHMM format)
      # This ensures each build has a unique, incrementing version code
      new_version_code = Time.now.strftime("%y%m%d%H%M").to_i
      UI.important("‚ö†Ô∏è  Google Play API unavailable: #{e.message}")
      UI.important("üìÖ Using timestamp-based version code: #{new_version_code}")
    end

    # Build the Android App Bundle (AAB)
    gradle(
      task: 'bundle',
      build_type: 'Release',
      project_dir: 'android/',
      properties: {
        "versionName" => version,
        "versionCode" => new_version_code.to_s
      }
    )

    # Upload to Google Play Internal Testing track (if credentials are available)
    begin
      upload_to_play_store(
        track: 'internal',
        json_key: 'fastlane/google-play-api-key.json',
        skip_upload_apk: true,
        skip_upload_metadata: true,
        skip_upload_images: true,
        skip_upload_screenshots: true
      )
      UI.success("‚úÖ Successfully uploaded to Google Play Internal Testing!")
    rescue => e
      UI.important("‚ö†Ô∏è  Google Play upload failed: #{e.message}")
      UI.important("üì¶ AAB file is available in android/app/build/outputs/bundle/release/")
      UI.important("üí° To enable Play Store upload, configure GOOGLE_PLAY_JSON_KEY in CircleCI")
      # Don't fail the build - the AAB is still created and stored as artifact
    end
  end

  desc "Promote Internal to Beta"
  lane :promote_beta do
    upload_to_play_store(
      track: 'internal',
      track_promote_to: 'beta',
      json_key: 'fastlane/google-play-api-key.json',
      skip_upload_apk: true,
      skip_upload_aab: true
    )
  end

  desc "Promote Beta to Production"
  lane :promote_production do
    upload_to_play_store(
      track: 'beta',
      track_promote_to: 'production',
      json_key: 'fastlane/google-play-api-key.json',
      skip_upload_apk: true,
      skip_upload_aab: true
    )
  end
end
