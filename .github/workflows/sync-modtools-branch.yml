name: Sync master to modtools branch

on:
  push:
    branches:
      - master

jobs:
  sync-modtools:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout master branch
        uses: actions/checkout@v4
        with:
          ref: master
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Configure git
        run: |
          git config user.name "GitHub Actions Bot"
          git config user.email "actions@github.com"

      - name: Fetch modtools branch
        run: git fetch origin modtools

      - name: Get modtools netlify.toml
        run: |
          # Save the modtools-specific netlify.toml
          git show origin/modtools:netlify.toml > /tmp/modtools-netlify.toml

      - name: Update modtools branch to match master
        run: |
          git checkout modtools
          git reset --hard origin/master

          # Restore the ModTools-specific netlify.toml
          cp /tmp/modtools-netlify.toml netlify.toml

          # Commit the netlify.toml if it changed
          if ! git diff --quiet netlify.toml; then
            git add netlify.toml
            git commit -m "Sync master to modtools - preserve ModTools netlify.toml

            Automated sync from master branch.
            ModTools-specific build configuration preserved.

            ðŸ¤– Automated by GitHub Actions"
          fi

      - name: Push modtools branch
        run: |
          git push origin modtools --force-with-lease
          echo "âœ… Successfully synced master to modtools branch"

      - name: Summary
        run: |
          echo "ðŸ“¦ modtools branch synced with master"
          echo "ðŸ”§ ModTools-specific netlify.toml preserved"
          echo "ðŸš€ Netlify branch deploy will trigger automatically"
