name: Auto-merge production to app-ci-fd

on:
  schedule:
    # Run at 11pm UTC every day
    - cron: '0 23 * * *'
  workflow_dispatch: # Allow manual trigger

jobs:
  auto-merge:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout app-ci-fd branch
        uses: actions/checkout@v4
        with:
          ref: app-ci-fd
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Configure git
        run: |
          git config user.name "GitHub Actions Bot"
          git config user.email "actions@github.com"

      - name: Fetch production branch
        run: git fetch origin production

      - name: Check if merge is needed
        id: check
        run: |
          # Check if production has changes not in app-ci-fd
          git merge-base --is-ancestor origin/production HEAD && echo "up-to-date=true" >> $GITHUB_OUTPUT || echo "up-to-date=false" >> $GITHUB_OUTPUT

      - name: Merge production into app-ci-fd
        if: steps.check.outputs.up-to-date == 'false'
        id: merge
        continue-on-error: true
        run: |
          git merge origin/production -m "Auto-merge production to app-ci-fd (daily scheduled)

          Automated merge from production branch after successful tests.

          ü§ñ Automated by GitHub Actions"

      - name: Push merged changes
        if: steps.merge.outcome == 'success'
        run: |
          git push origin app-ci-fd
          echo "‚úÖ Successfully merged and pushed production to app-ci-fd"

      - name: Trigger CircleCI build
        if: steps.merge.outcome == 'success'
        env:
          CIRCLECI_TOKEN: ${{ secrets.CIRCLECI_TOKEN }}
        run: |
          echo "üöÄ Triggering CircleCI build..."
          curl -X POST \
            -H "Circle-Token: ${CIRCLECI_TOKEN}" \
            -H "Content-Type: application/json" \
            -d '{"branch":"app-ci-fd"}' \
            "https://circleci.com/api/v2/project/gh/Freegle/iznik-nuxt3/pipeline"

      - name: Send merge failure notification
        if: steps.merge.outcome == 'failure'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'üö® Auto-merge failed: production ‚Üí app-ci-fd',
              body: `## Merge Conflict Detected

              The scheduled daily merge from \`production\` to \`app-ci-fd\` failed due to conflicts.

              **Action Required:**
              1. Manually resolve conflicts:
                 \`\`\`bash
                 git checkout app-ci-fd
                 git merge production
                 # Resolve conflicts
                 git commit
                 git push origin app-ci-fd
                 \`\`\`

              2. Or review the conflict and decide how to proceed

              **Workflow Run:** ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}

              ü§ñ Automated notification from GitHub Actions`,
              labels: ['auto-merge-conflict', 'needs-attention']
            })

      - name: Summary
        if: always()
        run: |
          if [ "${{ steps.check.outputs.up-to-date }}" == "true" ]; then
            echo "‚ÑπÔ∏è  app-ci-fd is already up-to-date with production"
          elif [ "${{ steps.merge.outcome }}" == "success" ]; then
            echo "‚úÖ Successfully merged production to app-ci-fd and triggered build"
          elif [ "${{ steps.merge.outcome }}" == "failure" ]; then
            echo "‚ùå Merge failed - conflicts detected. Issue created."
          fi
