name: Reset app-ci-fd to production

on:
  schedule:
    # Run at 11pm UTC every day
    - cron: '0 23 * * *'
  workflow_dispatch: # Allow manual trigger

jobs:
  reset-branch:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: production
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Configure git
        run: |
          git config user.name "GitHub Actions Bot"
          git config user.email "actions@github.com"

      - name: Check if reset is needed
        id: check
        run: |
          git fetch origin app-ci-fd
          PROD_SHA=$(git rev-parse HEAD)
          APP_SHA=$(git rev-parse origin/app-ci-fd)
          if [ "$PROD_SHA" == "$APP_SHA" ]; then
            echo "up-to-date=true" >> $GITHUB_OUTPUT
            echo "‚ÑπÔ∏è  app-ci-fd already matches production ($PROD_SHA)"
          else
            echo "up-to-date=false" >> $GITHUB_OUTPUT
            echo "üîÑ Will reset app-ci-fd ($APP_SHA) to production ($PROD_SHA)"
          fi

      - name: Reset app-ci-fd to production
        if: steps.check.outputs.up-to-date == 'false'
        run: |
          git push --force origin HEAD:app-ci-fd
          echo "‚úÖ Reset app-ci-fd to match production"

      - name: Trigger CircleCI build
        if: steps.check.outputs.up-to-date == 'false'
        env:
          CIRCLECI_TOKEN: ${{ secrets.CIRCLECI_TOKEN }}
        run: |
          echo "üöÄ Triggering CircleCI build..."
          curl -X POST \
            -H "Circle-Token: ${CIRCLECI_TOKEN}" \
            -H "Content-Type: application/json" \
            -d '{"branch":"app-ci-fd"}' \
            "https://circleci.com/api/v2/project/gh/Freegle/iznik-nuxt3/pipeline"

      - name: Summary
        if: always()
        run: |
          if [ "${{ steps.check.outputs.up-to-date }}" == "true" ]; then
            echo "‚ÑπÔ∏è  app-ci-fd already matches production - no action needed"
          else
            echo "‚úÖ Reset app-ci-fd to production and triggered CircleCI build"
          fi
