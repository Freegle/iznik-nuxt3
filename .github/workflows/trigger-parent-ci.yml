name: Update Parent Repository Submodule

on:
  push:
    branches: [ master, main, develop ]
  workflow_dispatch:

jobs:
  update-parent-submodule:
    runs-on: ubuntu-latest
    steps:
      - name: Update FreegleDocker submodule reference
        env:
          GH_TOKEN: ${{ secrets.FREEGLE_DOCKER_TOKEN }}
        run: |
          echo "ðŸ”„ Updating FreegleDocker submodule reference"
          echo "Repository: ${{ github.repository }}"
          echo "Branch: ${{ github.ref_name }}"
          echo "Commit: ${{ github.sha }}"
          echo "Commit Message: ${{ github.event.head_commit.message }}"

          # Determine submodule name from repository
          REPO_NAME=$(echo "${{ github.repository }}" | cut -d'/' -f2)
          echo "Submodule name: $REPO_NAME"

          # Clone FreegleDocker (no --depth 1 so we can rebase)
          echo "Cloning FreegleDocker..."
          git clone https://x-access-token:${GH_TOKEN}@github.com/Freegle/FreegleDocker.git
          cd FreegleDocker

          # Configure git
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"

          # Initialize and update just this submodule to get .git metadata
          git submodule init "$REPO_NAME"
          git submodule update "$REPO_NAME"

          # Update submodule to the specific commit that triggered this workflow
          echo "Updating $REPO_NAME submodule to commit ${{ github.sha }}..."
          cd "$REPO_NAME"
          git fetch origin "${{ github.sha }}"
          git checkout "${{ github.sha }}"
          cd ..

          # Check if there are changes
          if git diff --quiet "$REPO_NAME"; then
            echo "âœ… Submodule already at correct commit - no update needed"
            exit 0
          fi

          # Get first line of commit message, properly escaped
          COMMIT_MSG=$(cat <<'COMMIT_MSG_EOF'
          ${{ github.event.head_commit.message }}
          COMMIT_MSG_EOF
          )
          # Take first line only and sanitize
          COMMIT_MSG=$(echo "$COMMIT_MSG" | head -1 | tr -d '"' | sed 's/^[[:space:]]*//')

          # Push with retry logic to handle concurrent submodule updates
          MAX_RETRIES=5
          RETRY_DELAY=2

          for i in $(seq 1 $MAX_RETRIES); do
            echo "Push attempt $i of $MAX_RETRIES..."

            # Stage the submodule change
            git add "$REPO_NAME"

            # Check if there are changes to commit (might be up to date after rebase)
            if git diff --cached --quiet; then
              echo "âœ… Submodule already at correct commit after rebase - no update needed"
              exit 0
            fi

            # Commit
            git commit -m "Update $REPO_NAME submodule - $COMMIT_MSG"

            # Try to push
            if git push origin master; then
              echo "âœ… Successfully updated FreegleDocker submodule reference"
              echo "CircleCI will automatically trigger from this push"
              exit 0
            fi

            echo "âš ï¸ Push failed (likely concurrent update), retrying..."

            # Pull with rebase to incorporate other changes
            # Reset our commit, pull latest, then our change will be re-staged in next iteration
            git reset --soft HEAD~1
            git fetch origin master
            git reset --hard origin/master

            # Re-checkout the submodule to the correct commit
            cd "$REPO_NAME"
            git checkout "${{ github.sha }}"
            cd ..

            # Wait before retrying (exponential backoff)
            SLEEP_TIME=$((RETRY_DELAY * i))
            echo "Waiting ${SLEEP_TIME}s before retry..."
            sleep $SLEEP_TIME
          done

          echo "âŒ Failed to push after $MAX_RETRIES attempts"
          exit 1