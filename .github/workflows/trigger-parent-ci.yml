name: Update Parent Repository Submodule

on:
  push:
    branches: [ master, main ]
  workflow_dispatch:

jobs:
  update-parent-submodule:
    runs-on: ubuntu-latest
    steps:
      - name: Update FreegleDocker submodule reference
        env:
          GH_TOKEN: ${{ secrets.FREEGLE_DOCKER_TOKEN }}
        run: |
          echo "ðŸ”„ Updating FreegleDocker submodule reference"
          echo "Repository: ${{ github.repository }}"
          echo "Branch: ${{ github.ref_name }}"
          echo "Commit: ${{ github.sha }}"
          echo "Commit Message: ${{ github.event.head_commit.message }}"

          # Determine submodule name from repository
          REPO_NAME=$(echo "${{ github.repository }}" | cut -d'/' -f2)
          echo "Submodule name: $REPO_NAME"

          # Clone FreegleDocker
          echo "Cloning FreegleDocker..."
          git clone --depth 1 https://x-access-token:${GH_TOKEN}@github.com/Freegle/FreegleDocker.git
          cd FreegleDocker

          # Configure git
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"

          # Initialize and update just this submodule to get .git metadata
          git submodule init "$REPO_NAME"
          git submodule update "$REPO_NAME"

          # Update submodule to the specific commit that triggered this workflow
          echo "Updating $REPO_NAME submodule to commit ${{ github.sha }}..."
          cd "$REPO_NAME"
          git fetch origin "${{ github.sha }}"
          git checkout "${{ github.sha }}"
          cd ..

          # Check if there are changes
          if git diff --quiet "$REPO_NAME"; then
            echo "âœ… Submodule already at correct commit - no update needed"
            exit 0
          fi

          # Commit and push
          git add "$REPO_NAME"
          COMMIT_MSG="${{ github.event.head_commit.message }}"
          # Sanitize commit message - take first line only, remove quotes
          COMMIT_MSG=$(echo "$COMMIT_MSG" | head -1 | tr -d '"')
          git commit -m "Update $REPO_NAME submodule - $COMMIT_MSG"

          echo "Pushing to FreegleDocker..."
          git push origin master

          echo "âœ… Successfully updated FreegleDocker submodule reference"
          echo "CircleCI will automatically trigger from this push"