import config from './config'

export default defineNuxtConfig({
  _cli: false,

  // Rendering modes are confusing.
  //
  // target: can be static (can host on static hosting such as Azure Static Web Apps) or server (requires a node server).
  //
  // target: static and ssr: true doesn't work because of issues with Bootstrap and/or bootstrap-vue-3.  I'm not
  // clear which, but the bootstrap-vue-3 project isn't particularly interested in supporting SSR.
  // So for static targets, we must have ssr: false.
  //
  // This means that the pages are generated but only contain the scripts required to render on the client, and not
  // the full pre-rendered HTML. This functions fine for users and SEO (which nowadays executes JS).
  // But Facebook preview doesn't execute JS, which means that url preview doesn't work.
  //
  // target: server and ssr: false would be a bit pointless - you'd require non-static hosting but not gain anything
  // over target: static and ssr: false, so far as I can see.
  //
  // target: server and ssr: true I've not tried yet.  That would be a solution for Facebook preview, but would
  // need more expensive hosting.

  target: 'static',
  ssr: false,

  nitro: {
    prerender: {
      routes: ['/404.html', '/sitemap.xml'],
    },
  },

  build: {
    // Need to transpile otherwise SSR fails - see https://github.com/nuxt/framework/discussions/4523.
    transpile: [
      /bootstrap-vue-3/,
      /vue3-lazyload/,
      /vue-image-zoomer/,
      /vue3-draggable-resizable/,
      /pinia-plugin-persist/,
    ],
  },

  webpack: {
    // Reduce size of CSS initial load.
    extractCSS: true,
  },

  buildModules: [
    [
      '@pinia/nuxt',
      {
        autoImports: ['defineStore'],
      },
    ],
    'floating-vue/nuxt',
  ],

  axios: {
    proxy: true,
  },

  // Environment variables the client needs.
  runtimeConfig: {
    public: {
      APIv1: config.APIv1,
      APIv2: config.APIv2,
      OSM_TILE: config.OSM_TILE,
      GEOCODE: config.GEOCODE,
      FACEBOOK_APPID: config.FACEBOOK_APPID,
      YAHOO_CLIENTID: config.YAHOO_CLIENTID,
      GOOGLE_MAPS_KEY: config.GOOGLE_MAPS_KEY,
      GOOGLE_API_KEY: config.GOOGLE_API_KEY,
      GOOGLE_CLIENT_ID: config.GOOGLE_CLIENT_ID,
      USER_SITE: config.USER_SITE,
      IMAGE_SITE: config.IMAGE_SITE,
      SENTRY_DSN: config.SENTRY_DSN,
      BUILD_DATE: new Date().toISOString(),
    },
  },

  css: [
    '@/node_modules/@fortawesome/fontawesome-svg-core/styles.css',
    '@/assets/css/global.scss',
    'leaflet/dist/leaflet.css',
  ],

  vite: {
    css: {
      preprocessorOptions: {
        scss: {
          additionalData:
            // Include some CSS in all components.
            // TODO MINOR Tried to include these but broke the colours:
            // @import '~bootstrap/scss/functions';
            // @import '~bootstrap/scss/variables';
            // @import '~bootstrap/scss/mixins/_breakpoints';
            //
            '@import "@/assets/css/_color-vars.scss";',
        },
      },
    },
  },

  generate: {
    // Don't crawl - we end up with all the messages, which takes too long.
    crawler: false,

    // TODO Do something here.  Hybrid?  Depends on how well Google can index and Facebook/Twitter can preview.
  },

  app: {
    head: {
      title: "Freegle - Don't throw it away, give it away!",
      meta: [
        { charset: 'utf-8' },
        { name: 'viewport', content: 'width=device-width, initial-scale=1' },
        { hid: 'author', name: 'author', content: 'Freegle' },
        { name: 'supported-color-schemes', content: 'light' },
        { name: 'color-scheme', content: 'light' },
        {
          name: 'facebook-domain-verification',
          content: 'zld0jt8mvf06rt1c3fnxvls3zntxj6',
        },
        { hid: 'og:type', property: 'og:type', content: 'website' },
        {
          hid: 'description',
          name: 'description',
          content:
            "Give and get stuff for free in your local community.  Don't just recycle - reuse, freecycle and freegle!",
        },
        {
          hid: 'apple-mobile-web-app-title',
          name: 'apple-mobile-web-app-title',
          content:
            "Give and get stuff for free in your local community.  Don't just recycle - reuse, freecycle and freegle!",
        },

        {
          hid: 'og:image',
          property: 'og:image',
          content: config.USER_SITE + '/icon.png',
        },
        { hid: 'og:locale', property: 'og:locale', content: 'en_GB' },
        {
          hid: 'og:title',
          property: 'og:title',
          content: "Freegle - Don't throw it away, give it away!",
        },
        { hid: 'og:site_name', property: 'og:site_name', content: 'Freegle' },
        {
          hid: 'og:url',
          property: 'og:url',
          content: 'https://www.ilovefreegle.org',
        },
        {
          hid: 'fb:app_id',
          property: 'fb:app_id',
          content: config.FACEBOOK_APPID,
        },
        {
          hid: 'og:description',
          property: 'og:description',
          content:
            "Give and get stuff for free in your local community.  Don't just recycle - reuse, freecycle and freegle!",
        },
        {
          hid: 'fb:app_id',
          property: 'og:site_name',
          content: config.FACEBOOK_APPID,
        },

        {
          hid: 'twitter:title',
          name: 'twitter:title',
          content: "Freegle - Don't throw it away, give it away!",
        },
        {
          hid: 'twitter:description',
          name: 'twitter:description',
          content:
            "Give and get stuff for free in your local community.  Don't just recycle - reuse, freecycle and freegle!",
        },
        {
          hid: 'twitter:image',
          name: 'twitter:image',
          content: config.USER_SITE + '/icon.png',
        },
        {
          hid: 'twitter:image:alt',
          name: 'twitter:image:alt',
          content: 'The Freegle logo',
        },
        {
          hid: 'twitter:card',
          name: 'twitter:card',
          content: 'summary_large_image',
        },
        { hid: 'twitter:site', name: 'twitter:site', content: 'thisisfreegle' },
      ],
    },
  },
})
