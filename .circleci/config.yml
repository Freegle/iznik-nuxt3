version: 2.1

parameters:
  run_manual_promote:
    type: boolean
    default: false
    description: "Set to true to manually trigger promotion/submission workflow"
  build_testflight:
    type: boolean
    default: false
    description: "Set to true to build iOS and upload to TestFlight from current branch"

orbs:
  android: circleci/android@2.3.0
  freegle: freegle/tests@1

executors:
  android-executor:
    docker:
      - image: cimg/android:2025.10-node
    resource_class: large

  macos-executor:
    macos:
      xcode: 16.2.0
    resource_class: macos.m1.medium.gen1

commands:
  setup-android-fastlane:
    steps:
      - run:
          name: Install Ruby and Bundler
          command: |
            sudo apt-get update
            sudo apt-get install -y ruby-full
            sudo gem install bundler
      - run:
          name: Install Fastlane
          command: |
            bundle config set --local path 'vendor/bundle'
            # Update Fastlane to latest version
            bundle update fastlane
            bundle install
      - run:
          name: Decode Google Play JSON Key
          command: |
            echo "üîê Decoding Google Play JSON Key..."

            # Check if environment variable is set
            if [ -z "$GOOGLE_PLAY_JSON_KEY" ]; then
              echo "‚ùå CRITICAL: GOOGLE_PLAY_JSON_KEY environment variable is not set"
              exit 1
            fi

            # Decode the key
            echo $GOOGLE_PLAY_JSON_KEY | base64 -d > fastlane/google-play-api-key.json

            # Validate the file was created
            if [ ! -f fastlane/google-play-api-key.json ]; then
              echo "‚ùå CRITICAL: Failed to create google-play-api-key.json"
              exit 1
            fi

            # Check file size
            FILE_SIZE=$(wc -c < fastlane/google-play-api-key.json)
            echo "‚úÖ File created: $FILE_SIZE bytes"

            if [ "$FILE_SIZE" -eq 0 ]; then
              echo "‚ùå CRITICAL: google-play-api-key.json is empty"
              exit 1
            fi

            # Validate JSON syntax
            if python3 -m json.tool fastlane/google-play-api-key.json > /dev/null 2>&1; then
              echo "‚úÖ Valid JSON structure"
              # Show project email (not sensitive, useful for debugging)
              echo "üìß Service Account: $(python3 -c "import json; print(json.load(open('fastlane/google-play-api-key.json'))['client_email'])")"
            else
              echo "‚ùå CRITICAL: Invalid JSON - Google Play API will not work!"
              exit 1
            fi

            echo "‚úÖ Google Play JSON Key validated successfully"

jobs:
  increment-version:
    docker:
      - image: cimg/base:stable
    steps:
      - run:
          name: Increment Version Number
          command: |
            # Get current version from environment variable
            CURRENT_VERSION="${CURRENT_VERSION:-3.2.37}"
            echo "Current version: $CURRENT_VERSION"

            # Parse and increment patch version
            major=$(echo "$CURRENT_VERSION" | cut -d. -f1)
            minor=$(echo "$CURRENT_VERSION" | cut -d. -f2)
            patch=$(echo "$CURRENT_VERSION" | cut -d. -f3)
            NEW_PATCH=$((patch + 1))
            NEW_VERSION="$major.$minor.$NEW_PATCH"

            echo "New version: $NEW_VERSION"

            # Write to file for other jobs to read
            echo "$NEW_VERSION" > .new_version
            cat .new_version

      - persist_to_workspace:
          root: .
          paths:
            - .new_version

  build-android-dev-app:
    executor: android-executor
    steps:
      - checkout

      # Install Node.js 22
      - run:
          name: Install Node.js 22
          command: |
            curl -fsSL https://deb.nodesource.com/setup_22.x | sudo -E bash -
            sudo apt-get install -y nodejs

      - run:
          name: Verify Node.js and npm versions
          command: |
            node --version
            npm --version

      # Restore npm cache
      - restore_cache:
          keys:
            - npm-deps-v1-{{ checksum "package-lock.json" }}
            - npm-deps-v1-

      # Install Node.js dependencies
      - run:
          name: Install Node.js Dependencies
          command: |
            npm ci
            # Force update GitHub-hosted packages to latest (bypasses package-lock.json pinning)
            npm update @freegle/capacitor-push-notifications-cap7

      - save_cache:
          key: npm-deps-v1-{{ checksum "package-lock.json" }}
          paths:
            - node_modules

      # Use minimal dev-app instead of full Nuxt build
      # This avoids initialization issues and just shows a connection screen
      - run:
          name: Setup Dev App Web Content
          command: |
            echo "üîß Setting up minimal dev app (connection screen only)"
            # The dev-app folder contains a simple HTML page for server connection
            # No Nuxt build needed - the app redirects to dev server after connecting

            # Add build timestamp to the HTML
            BUILD_TIME=$(date -u '+%Y-%m-%d %H:%M:%S UTC')
            sed -i "s|</body>|<p style=\"text-align:center;font-size:11px;color:#999;margin-top:20px;\">Build: ${BUILD_TIME}</p></body>|" dev-app/index.html

            ls -la dev-app/
            echo "‚úÖ Dev app web content ready (using dev-app/ folder)"

      # Setup Firebase for dev app (now registered in Firebase)
      - run:
          name: Setup Firebase Configuration
          command: |
            if [ -n "$GOOGLE_SERVICES_JSON_BASE64" ]; then
              echo "Decoding google-services.json"
              echo "$GOOGLE_SERVICES_JSON_BASE64" | base64 -d > android/app/google-services.json
              echo "‚úÖ Firebase configured for dev app"
            else
              echo "‚ö†Ô∏è  GOOGLE_SERVICES_JSON_BASE64 not set - Push notifications will not work"
            fi

      # Update Android app ID and name for dev app
      - run:
          name: Configure Dev App Identity
          command: |
            echo "üì± Configuring Freegle Dev app..."

            # Update build.gradle applicationId
            sed -i 's/org\.ilovefreegle\.direct/org.ilovefreegle.dev/g' android/app/build.gradle

            # Update app name in strings.xml (both app_name and title_activity_main)
            sed -i 's/>Freegle</>Freegle Dev</g' android/app/src/main/res/values/strings.xml

            # Update capacitor.config.json if it exists
            if [ -f capacitor.config.json ]; then
              sed -i 's/org\.ilovefreegle\.direct/org.ilovefreegle.dev/g' capacitor.config.json
              sed -i 's/"appName": "Freegle"/"appName": "Freegle Dev"/g' capacitor.config.json
            fi

            echo "‚úÖ Dev app identity configured"
            echo "   Package ID: org.ilovefreegle.dev"
            echo "   App Name: Freegle Dev"

      # Convert app icons to greyscale for dev app
      - run:
          name: Create Greyscale Icons (Dev)
          command: |
            echo "üé® Converting app icons to greyscale..."
            sudo apt-get update && sudo apt-get install -y imagemagick

            # Convert all launcher icons to greyscale
            find android/app/src/main/res -name "ic_launcher*.png" -type f | while read icon; do
              echo "  Converting: $icon"
              convert "$icon" -colorspace Gray "$icon"
            done

            echo "‚úÖ Icons converted to greyscale"

      # Allow cleartext HTTP for dev servers
      - run:
          name: Enable HTTP for Dev Servers
          command: |
            echo "üì° Enabling cleartext HTTP for local dev server connections..."

            # Add network security config for cleartext
            mkdir -p android/app/src/main/res/xml
            echo '<?xml version="1.0" encoding="utf-8"?>' > android/app/src/main/res/xml/network_security_config.xml
            echo '<network-security-config>' >> android/app/src/main/res/xml/network_security_config.xml
            echo '    <base-config cleartextTrafficPermitted="true">' >> android/app/src/main/res/xml/network_security_config.xml
            echo '        <trust-anchors>' >> android/app/src/main/res/xml/network_security_config.xml
            echo '            <certificates src="system" />' >> android/app/src/main/res/xml/network_security_config.xml
            echo '        </trust-anchors>' >> android/app/src/main/res/xml/network_security_config.xml
            echo '    </base-config>' >> android/app/src/main/res/xml/network_security_config.xml
            echo '</network-security-config>' >> android/app/src/main/res/xml/network_security_config.xml

            # Reference network config in AndroidManifest if not already present
            if ! grep -q 'networkSecurityConfig' android/app/src/main/AndroidManifest.xml; then
              sed -i 's/<application/<application android:networkSecurityConfig="@xml\/network_security_config"/g' android/app/src/main/AndroidManifest.xml
            fi

            echo "‚úÖ HTTP enabled for dev servers"

      # Sync Capacitor with dev config
      - run:
          name: Sync Capacitor to Android (Dev)
          command: |
            # Remove the TypeScript config so our JS config is used
            rm -f capacitor.config.ts

            # Copy dev config as the main config
            echo "Using capacitor.config.dev.js"
            cp capacitor.config.dev.js capacitor.config.js

            # Verify the dev-app directory exists
            ls -la dev-app/

            npx cap sync android

      # Modify MainActivity to allow all WebView navigation (no external browser)
      - run:
          name: Configure WebView Navigation
          command: |
            echo "üîß Configuring MainActivity to keep all navigation in WebView..."

            MAIN_ACTIVITY="android/app/src/main/java/org/ilovefreegle/dev/MainActivity.java"

            # Ensure the directory exists
            mkdir -p "$(dirname "$MAIN_ACTIVITY")"

            # Create the modified MainActivity
            cat > "$MAIN_ACTIVITY" << 'JAVAEOF'
package org.ilovefreegle.dev;

import android.os.Bundle;
import android.util.Log;
import android.webkit.WebView;
import android.webkit.WebViewClient;
import android.webkit.WebResourceRequest;
import com.getcapacitor.BridgeActivity;

public class MainActivity extends BridgeActivity {
  private static final String TAG = "FreegleDev";

  @Override
  public void onCreate(Bundle savedInstanceState) {
    super.onCreate(savedInstanceState);

    // Enable WebView debugging for chrome://inspect
    WebView.setWebContentsDebuggingEnabled(true);
    Log.d(TAG, "WebView debugging enabled");

    // Override WebViewClient to keep ALL navigation in the WebView
    // This prevents window.location.href from opening external browser
    getBridge().getWebView().setWebViewClient(new WebViewClient() {
      @Override
      public boolean shouldOverrideUrlLoading(WebView view, WebResourceRequest request) {
        String url = request.getUrl().toString();
        Log.d(TAG, "Navigation to: " + url);
        // Return false = load in WebView, not external browser
        return false;
      }

      @Override
      public boolean shouldOverrideUrlLoading(WebView view, String url) {
        Log.d(TAG, "Navigation to (legacy): " + url);
        return false;
      }
    });

    Log.d(TAG, "WebViewClient configured to keep navigation in WebView");
  }
}
JAVAEOF

            echo "‚úÖ MainActivity configured for in-WebView navigation"

      - run:
          name: Make gradlew executable
          command: chmod +x android/gradlew

      # Create debug keystore
      - run:
          name: Create Debug Keystore
          command: |
            mkdir -p ~/.android
            if [ ! -f ~/.android/debug.keystore ]; then
              keytool -genkey -v \
                -keystore ~/.android/debug.keystore \
                -storepass android \
                -alias androiddebugkey \
                -keypass android \
                -keyalg RSA \
                -keysize 2048 \
                -validity 10000 \
                -dname "CN=Android Debug,O=Android,C=US"
            fi

      # Build debug APK
      - run:
          name: Build Dev App APK
          command: |
            cd android
            ./gradlew assembleDebug --stacktrace
            echo "‚úÖ Freegle Dev APK built successfully"
            ls -lh app/build/outputs/apk/debug/

      # Store the dev APK as artifact
      - store_artifacts:
          path: android/app/build/outputs/apk/debug/app-debug.apk
          destination: freegle-dev.apk

      - run:
          name: Build Complete
          command: |
            echo "üéâ Freegle Dev app build complete!"
            echo ""
            echo "üì± This is a development app that:"
            echo "   - Has package ID: org.ilovefreegle.dev"
            echo "   - Can coexist with production Freegle app"
            echo "   - Connects to your local dev server via QR code"
            echo "   - Has WebView debugging enabled (chrome://inspect)"
            echo "   - Allows HTTP connections to local dev servers"
            echo "   - Instant hot reload for Vue/JS/CSS changes"
            echo ""
            echo "üìñ Setup instructions:"
            echo "1. Download freegle-dev.apk from artifacts"
            echo "2. Install on your Android device (enable 'Install from unknown sources')"
            echo "3. Start your dev server: docker-compose up -d"
            echo "4. Open http://status.localhost/dev-connect on your computer"
            echo "5. Scan the QR code with the Freegle Dev app"
            echo "6. Make code changes - they appear instantly!"
            echo ""
            echo "üîç Debug via: chrome://inspect/#devices"
            echo ""
            echo "‚ö†Ô∏è  Note: This APK uses a different package ID, so it won't"
            echo "    conflict with the production Freegle app."

  build-android:
    executor: android-executor
    steps:
      - checkout

      # Attach workspace to get pre-calculated version
      - attach_workspace:
          at: .

      # Install Node.js 22
      - run:
          name: Install Node.js 22
          command: |
            # Download and install Node.js 22
            curl -fsSL https://deb.nodesource.com/setup_22.x | sudo -E bash -
            sudo apt-get install -y nodejs

      # Verify Node.js version
      - run:
          name: Verify Node.js and npm versions
          command: |
            node --version
            npm --version

      # Restore npm cache
      - restore_cache:
          keys:
            - npm-deps-v1-{{ checksum "package-lock.json" }}
            - npm-deps-v1-

      # Install Node.js dependencies
      - run:
          name: Install Node.js Dependencies
          command: npm ci

      - save_cache:
          key: npm-deps-v1-{{ checksum "package-lock.json" }}
          paths:
            - node_modules

      # Update MOBILE_VERSION in config.js before build
      - run:
          name: Update Mobile Version in config.js
          command: |
            # Read pre-calculated version from workspace file
            # Version was already incremented by the increment-version job
            if [ ! -f .new_version ]; then
              echo "‚ùå ERROR: Version file not found at .new_version"
              echo "üí° The increment-version job should have created this file"
              exit 1
            fi

            NEW_VERSION=$(cat .new_version)
            echo "üì± Using version from workspace: $NEW_VERSION"

            # Validate version format (X.Y.Z)
            if ! echo "$NEW_VERSION" | grep -qE '^[0-9]+\.[0-9]+\.[0-9]+$'; then
              echo "‚ùå ERROR: Invalid version format '$NEW_VERSION'. Expected format: X.Y.Z"
              exit 1
            fi

            # Update MOBILE_VERSION in config.js
            sed -i "s/MOBILE_VERSION: '[0-9]*\.[0-9]*\.[0-9]*'/MOBILE_VERSION: '$NEW_VERSION'/" config.js

            # Verify the update
            if grep -q "MOBILE_VERSION: '$NEW_VERSION'" config.js; then
              echo "‚úÖ Successfully updated config.js with version $NEW_VERSION"
              grep "MOBILE_VERSION:" config.js
            else
              echo "‚ùå ERROR: Failed to update config.js"
              exit 1
            fi

      # Build Nuxt app for production
      - run:
          name: Build Nuxt App
          command: |
            export ISAPP=true
            export APP_ENV=production
            # Set Sentry DSN from app-specific environment variable
            if [ -n "$SENTRY_DSN_APP_FD" ]; then
              export SENTRY_DSN="$SENTRY_DSN_APP_FD"
              echo "‚úÖ Using app-specific Sentry DSN for error tracking"
            else
              echo "‚ö†Ô∏è  SENTRY_DSN_APP_FD not set - app will use default Sentry DSN"
            fi
            npm run generate

      # Decode and place google-services.json for Firebase
      - run:
          name: Setup Firebase Configuration
          command: |
            if [ -n "$GOOGLE_SERVICES_JSON_BASE64" ]; then
              echo "Decoding google-services.json from environment variable"
              echo "$GOOGLE_SERVICES_JSON_BASE64" | base64 -d > android/app/google-services.json

              # Validate the decoded file
              if [ -f android/app/google-services.json ]; then
                FILE_SIZE=$(wc -c < android/app/google-services.json)
                echo "‚úÖ File created: $FILE_SIZE bytes"

                # Validate JSON syntax
                if python3 -m json.tool android/app/google-services.json > /dev/null 2>&1; then
                  echo "‚úÖ Valid JSON structure"
                  # Show project info (not sensitive)
                  echo "üì± Project ID: $(python3 -c "import json; print(json.load(open('android/app/google-services.json'))['project_info']['project_id'])")"
                else
                  echo "‚ùå ERROR: Invalid JSON - Firebase will not work!"
                  exit 1
                fi
              else
                echo "‚ùå ERROR: File was not created!"
                exit 1
              fi
            else
              echo "‚ö†Ô∏è  GOOGLE_SERVICES_JSON_BASE64 not set - Push notifications will not work"
              echo "   Add this environment variable in CircleCI project settings"
            fi

      # Sync Capacitor
      - run:
          name: Sync Capacitor to Android
          command: npx cap sync android

      # Make gradlew executable
      - run:
          name: Make gradlew executable
          command: chmod +x android/gradlew

      # Restore Fastlane bundle cache
      - restore_cache:
          keys:
            - bundle-v1-{{ checksum "Gemfile.lock" }}
            - bundle-v1-

      # Setup Fastlane
      - setup-android-fastlane

      - save_cache:
          key: bundle-v1-{{ checksum "Gemfile.lock" }}
          paths:
            - vendor/bundle

      # Build and Deploy to Beta Track
      - run:
          name: Build and Deploy to Google Play Beta Track
          command: |
            # Run fastlane and capture the new version
            bundle exec fastlane android beta

            # The NEW_VERSION is set by Fastlane in the environment
            # We'll update CircleCI env var in the next step

      # Update CircleCI CURRENT_VERSION environment variable
      - run:
          name: Update CircleCI Version Variable
          command: |
            # Read the new version written by Fastlane
            if [ ! -f .new_version ]; then
              echo "‚ö†Ô∏è  .new_version file not found - skipping version update"
              exit 0
            fi

            NEW_VERSION=$(cat .new_version)
            echo "üìù Updating CircleCI CURRENT_VERSION to: ${NEW_VERSION}"

            # Update environment variable via CircleCI API
            # First delete the old one
            curl -X DELETE \
              -H "Circle-Token: ${CIRCLECI_API_TOKEN}" \
              "https://circleci.com/api/v2/project/gh/Freegle/iznik-nuxt3/envvar/CURRENT_VERSION"

            # Then create new one with updated value
            curl -X POST \
              -H "Circle-Token: ${CIRCLECI_API_TOKEN}" \
              -H "Content-Type: application/json" \
              -d "{\"name\":\"CURRENT_VERSION\",\"value\":\"${NEW_VERSION}\"}" \
              "https://circleci.com/api/v2/project/gh/Freegle/iznik-nuxt3/envvar"

            echo "‚úÖ Updated CURRENT_VERSION to ${NEW_VERSION}"

      # Send email notification for beta release
      - run:
          name: Send Beta Release Notification
          when: on_success
          command: |
            NEW_VERSION=$(cat .new_version 2>/dev/null || echo "Unknown")

            # Send email using curl and a mail service
            # Requires NOTIFICATION_EMAIL environment variable to be set
            if [ -n "$NOTIFICATION_EMAIL" ]; then
              echo "üìß Sending beta release notification to ${NOTIFICATION_EMAIL}"

              # Create simple email body using echo to avoid YAML parsing issues
              {
                echo "Subject: üöÄ New Freegle Beta Release: ${NEW_VERSION}"
                echo ""
                echo "Freegle Android App - Beta Release Deployed"
                echo ""
                echo "Version: ${NEW_VERSION}"
                echo "Build: #${CIRCLE_BUILD_NUM}"
                echo "Branch: ${CIRCLE_BRANCH}"
                echo "Commit: ${CIRCLE_SHA1:0:8}"
                echo ""
                echo "The new beta version has been uploaded to Google Play Open Testing track."
                echo ""
                echo "üì± Release Notes: \"Version ${NEW_VERSION} - Bug fixes and improvements\""
                echo ""
                echo "üîó View in Play Console:"
                echo "https://play.google.com/console/u/0/developers/5213085306367696468/app/4972100654921386219/tracks/open-testing"
                echo ""
                echo "üîó CircleCI Build:"
                echo "${CIRCLE_BUILD_URL}"
                echo ""
                echo "This release will be automatically promoted to production at midnight UTC if no issues are found."
                echo ""
                echo "ü§ñ Automated notification from CircleCI"
              } > /tmp/email_body.txt

              # You can integrate with your preferred email service here
              # For now, just log the notification
              echo "‚úÖ Beta release notification prepared (set up email integration)"
              cat /tmp/email_body.txt
            else
              echo "‚ÑπÔ∏è  NOTIFICATION_EMAIL not set - skipping email notification"
            fi

      # Store build artifacts
      - store_artifacts:
          path: android/app/build/outputs/bundle/release/
          destination: android-bundle
      - store_artifacts:
          path: android/app/build/outputs/apk/release/
          destination: android-apk

      # Store debug artifacts
      - run:
          name: Create build info file
          command: |
            echo "Build #${CIRCLE_BUILD_NUM}" > build-info.txt
            echo "Branch: ${CIRCLE_BRANCH}" >> build-info.txt
            echo "Commit: ${CIRCLE_SHA1}" >> build-info.txt
            echo "" >> build-info.txt
            echo "google-services.json status:" >> build-info.txt
            ls -la android/app/google-services.json >> build-info.txt 2>&1 || echo "  File not found" >> build-info.txt
            echo "" >> build-info.txt
            echo "Build outputs:" >> build-info.txt
            ls -lh android/app/build/outputs/bundle/release/ >> build-info.txt 2>&1 || echo "  Bundle not found" >> build-info.txt
            ls -lh android/app/build/outputs/apk/release/ >> build-info.txt 2>&1 || echo "  APK not found" >> build-info.txt
          when: always
      - store_artifacts:
          path: build-info.txt
          destination: build-info.txt
      - store_artifacts:
          path: android/app/build/reports/
          destination: gradle-reports
          when: always

  auto-promote-production:
    executor: android-executor
    steps:
      - checkout

      # Restore Fastlane bundle cache
      - restore_cache:
          keys:
            - bundle-v1-{{ checksum "Gemfile.lock" }}
            - bundle-v1-

      # Setup Fastlane
      - setup-android-fastlane

      # Check and auto-promote beta to production after 24 hours
      - run:
          name: Auto-promote Beta to Production
          command: |
            bundle exec fastlane android auto_promote
            # Store result for notification
            echo $? > /tmp/promote_status

      # Send email notification for production release
      - run:
          name: Send Production Release Notification
          when: on_success
          command: |
            # Check if promotion actually occurred (fastlane would have logged this)
            if [ -f /tmp/promote_status ] && [ "$(cat /tmp/promote_status)" = "0" ]; then
              VERSION=$(cat .new_version 2>/dev/null || echo "$CURRENT_VERSION")

              if [ -n "$NOTIFICATION_EMAIL" ]; then
                echo "üìß Sending production release notification to ${NOTIFICATION_EMAIL}"

                # Create email body using echo to avoid YAML parsing issues
                {
                  echo "Subject: ‚úÖ Freegle Production Release: ${VERSION}"
                  echo ""
                  echo "Freegle Android App - Production Release Deployed"
                  echo ""
                  echo "Version: ${VERSION}"
                  echo "Build: Auto-promoted from Beta"
                  echo "Branch: ${CIRCLE_BRANCH}"
                  echo ""
                  echo "The beta version has been automatically promoted to production after 24 hours in open testing."
                  echo ""
                  echo "üì± Release Notes: \"Version ${VERSION} - Bug fixes and improvements\""
                  echo ""
                  echo "üîó View in Play Console:"
                  echo "https://play.google.com/console/u/0/developers/5213085306367696468/app/4972100654921386219/tracks/production"
                  echo ""
                  echo "üîó CircleCI Workflow:"
                  echo "${CIRCLE_BUILD_URL}"
                  echo ""
                  echo "Users on Google Play will receive this update automatically."
                  echo ""
                  echo "ü§ñ Automated notification from CircleCI"
                } > /tmp/email_body.txt

                echo "‚úÖ Production release notification prepared (set up email integration)"
                cat /tmp/email_body.txt
              else
                echo "‚ÑπÔ∏è  NOTIFICATION_EMAIL not set - skipping email notification"
              fi
            else
              echo "‚ÑπÔ∏è  No promotion occurred (already in production or no beta release found)"
            fi

  auto-submit-ios:
    executor: macos-executor
    steps:
      - checkout

      # Install Node.js 22
      - run:
          name: Install Node.js 22
          command: |
            curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.39.0/install.sh | bash
            export NVM_DIR="$HOME/.nvm"
            [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"
            nvm install 22
            nvm use 22
            nvm alias default 22
            echo 'export NVM_DIR="$HOME/.nvm"' >> $BASH_ENV
            echo '[ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"' >> $BASH_ENV

      # Install Ruby and Fastlane dependencies
      - run:
          name: Install Fastlane
          command: |
            gem install bundler
            bundle update fastlane
            bundle install

      # Auto-submit latest TestFlight build to App Store review after 24 hours
      - run:
          name: Auto-submit Latest TestFlight Build to App Store Review
          command: |
            bundle exec fastlane ios auto_submit
            echo $? > /tmp/submit_status

      # Send notification if submission occurred
      - run:
          name: Send App Store Submission Notification
          when: on_success
          command: |
            if [ -f /tmp/submit_status ] && [ "$(cat /tmp/submit_status)" = "0" ]; then
              VERSION=$(cat .new_version 2>/dev/null || echo "$CURRENT_VERSION")

              echo "üìß App Store submission notification"
              echo ""
              echo "Subject: ‚úÖ Freegle iOS submitted for App Store review: ${VERSION}"
              echo ""
              echo "Freegle iOS App - Submitted for App Store Review"
              echo ""
              echo "Version: ${VERSION}"
              echo "Status: Submitted for review"
              echo "Branch: ${CIRCLE_BRANCH}"
              echo ""
              echo "The latest TestFlight build has been automatically submitted to App Store review."
              echo ""
              echo "‚è±Ô∏è  Review typically takes 24 hours (90% of submissions)"
              echo ""
              echo "üîó View in App Store Connect:"
              echo "https://appstoreconnect.apple.com/apps/1563499899/appstore/ios/version/deliverable"
              echo ""
              echo "üîó CircleCI Workflow:"
              echo "${CIRCLE_BUILD_URL}"
              echo ""
              echo "ü§ñ Automated notification from CircleCI"
            else
              echo "‚ÑπÔ∏è  No submission occurred (already in review or no new build found)"
            fi

  auto-release-ios:
    executor: macos-executor
    steps:
      - checkout

      # Install Node.js 22
      - run:
          name: Install Node.js 22
          command: |
            curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.39.0/install.sh | bash
            export NVM_DIR="$HOME/.nvm"
            [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"
            nvm install 22
            nvm use 22
            nvm alias default 22
            echo 'export NVM_DIR="$HOME/.nvm"' >> $BASH_ENV
            echo '[ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"' >> $BASH_ENV

      # Install Ruby and Fastlane dependencies
      - run:
          name: Install Fastlane
          command: |
            gem install bundler
            bundle update fastlane
            bundle install

      # Auto-release approved apps from Pending Developer Release state
      - run:
          name: Auto-release Apps from Pending Developer Release
          command: |
            bundle exec fastlane ios auto_release
            echo $? > /tmp/release_status

      # Send notification if release occurred
      - run:
          name: Send App Store Release Notification
          when: on_success
          command: |
            if [ -f /tmp/release_status ] && [ "$(cat /tmp/release_status)" = "0" ]; then
              VERSION=$(cat .new_version 2>/dev/null || echo "$CURRENT_VERSION")

              echo "üìß App Store release notification"
              echo ""
              echo "Subject: ‚úÖ Freegle iOS released to App Store: ${VERSION}"
              echo ""
              echo "Freegle iOS App - Released to App Store"
              echo ""
              echo "Version: ${VERSION}"
              echo "Status: Released to App Store"
              echo "Branch: ${CIRCLE_BRANCH}"
              echo ""
              echo "The app has been automatically released from Pending Developer Release state."
              echo ""
              echo "üîó View in App Store Connect:"
              echo "https://appstoreconnect.apple.com/apps/1563499899/appstore/ios/version/deliverable"
              echo ""
              echo "üîó CircleCI Workflow:"
              echo "${CIRCLE_BUILD_URL}"
              echo ""
              echo "The app is now available to users on the App Store."
              echo ""
              echo "ü§ñ Automated notification from CircleCI"
            else
              echo "‚ÑπÔ∏è  No release occurred (no apps in Pending Developer Release state)"
            fi

  build-ios:
    executor: macos-executor
    steps:
      - checkout

      # Attach workspace to get pre-calculated version
      - attach_workspace:
          at: .

      # Install Node.js 22
      - run:
          name: Install Node.js 22
          command: |
            # Install nvm
            curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.39.0/install.sh | bash
            export NVM_DIR="$HOME/.nvm"
            [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"

            # Install Node 22
            nvm install 22
            nvm use 22
            nvm alias default 22

            # Add to bash profile for subsequent steps
            echo 'export NVM_DIR="$HOME/.nvm"' >> $BASH_ENV
            echo '[ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"' >> $BASH_ENV

      # Verify versions
      - run:
          name: Verify Node.js and npm versions
          command: |
            node --version
            npm --version

      # Install Node.js dependencies (no cache on macOS - it's problematic)
      - run:
          name: Install Node.js Dependencies
          command: npm ci

      # Update MOBILE_VERSION in config.js before build
      - run:
          name: Update Mobile Version in config.js
          command: |
            # Read pre-calculated version from workspace file
            # Version was already incremented by the increment-version job
            if [ ! -f .new_version ]; then
              echo "‚ùå ERROR: Version file not found at .new_version"
              echo "üí° The increment-version job should have created this file"
              exit 1
            fi

            NEW_VERSION=$(cat .new_version)
            echo "üì± Using version from workspace: $NEW_VERSION"

            # Validate version format (X.Y.Z)
            if ! echo "$NEW_VERSION" | grep -qE '^[0-9]+\.[0-9]+\.[0-9]+$'; then
              echo "‚ùå ERROR: Invalid version format '$NEW_VERSION'. Expected format: X.Y.Z"
              exit 1
            fi

            # Update MOBILE_VERSION in config.js
            sed -i '' "s/MOBILE_VERSION: '[0-9]*\.[0-9]*\.[0-9]*'/MOBILE_VERSION: '$NEW_VERSION'/" config.js

            # Verify the update
            if grep -q "MOBILE_VERSION: '$NEW_VERSION'" config.js; then
              echo "‚úÖ Successfully updated config.js with version $NEW_VERSION"
              grep "MOBILE_VERSION:" config.js
            else
              echo "‚ùå ERROR: Failed to update config.js"
              exit 1
            fi

      # Build Nuxt app for production
      - run:
          name: Build Nuxt App
          command: |
            export ISAPP=true
            export APP_ENV=production
            if [ -n "$SENTRY_DSN_APP_FD" ]; then
              export SENTRY_DSN="$SENTRY_DSN_APP_FD"
              echo "‚úÖ Using app-specific Sentry DSN for error tracking"
            else
              echo "‚ö†Ô∏è  SENTRY_DSN_APP_FD not set - app will use default Sentry DSN"
            fi
            npm run generate

      # Sync Capacitor to iOS
      - run:
          name: Sync Capacitor to iOS
          command: npx cap sync ios

      # Decode and place GoogleService-Info.plist for Firebase
      - run:
          name: Setup Firebase Configuration for iOS
          command: |
            if [ -n "$GOOGLE_SERVICE_INFO_PLIST_BASE64" ]; then
              echo "Decoding GoogleService-Info.plist from environment variable"
              echo "$GOOGLE_SERVICE_INFO_PLIST_BASE64" | base64 --decode > ios/App/App/GoogleService-Info.plist

              # Validate the decoded file
              if [ -f ios/App/App/GoogleService-Info.plist ]; then
                echo "‚úÖ GoogleService-Info.plist successfully created"
                ls -lh ios/App/App/GoogleService-Info.plist
              else
                echo "‚ùå Failed to create GoogleService-Info.plist"
                exit 1
              fi
            else
              echo "‚ùå GOOGLE_SERVICE_INFO_PLIST_BASE64 environment variable not set"
              exit 1
            fi

      # Install Fastlane (no cache on macOS - it's problematic)
      - run:
          name: Install Fastlane
          command: |
            bundle config set --local path 'vendor/bundle'
            bundle update fastlane
            bundle install

      # Setup iOS Certificates and Provisioning Profiles
      - run:
          name: Setup iOS Certificates
          command: |
            # Decode certificates and profiles from CircleCI environment variables
            mkdir -p ~/certificates
            echo "$IOS_DISTRIBUTION_CERT" | base64 --decode > ~/certificates/ios_distribution.p12
            echo "$IOS_PROVISIONING_PROFILE" | base64 --decode > ~/certificates/ios_appstore.mobileprovision

            # Create a temporary keychain for code signing
            KEYCHAIN_PATH=~/Library/Keychains/temp.keychain-db
            KEYCHAIN_PASSWORD=circleci

            # Delete keychain if it exists
            security delete-keychain "$KEYCHAIN_PATH" 2>/dev/null || true

            # Create temporary keychain
            security create-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"

            # Set the keychain as default
            security default-keychain -s "$KEYCHAIN_PATH"

            # Unlock the keychain
            security unlock-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"

            # Set keychain timeout to 1 hour
            security set-keychain-settings -t 3600 -u "$KEYCHAIN_PATH"

            # Set paths and keychain info for Fastlane to use
            echo "export IOS_CERTIFICATE_PATH=~/certificates/ios_distribution.p12" >> $BASH_ENV
            echo "export IOS_PROVISIONING_PROFILE_PATH=~/certificates/ios_appstore.mobileprovision" >> $BASH_ENV
            echo "export KEYCHAIN_NAME=$KEYCHAIN_PATH" >> $BASH_ENV
            echo "export KEYCHAIN_PASSWORD=$KEYCHAIN_PASSWORD" >> $BASH_ENV

      # Build and Deploy to TestFlight
      - run:
          name: Build and Deploy to TestFlight
          command: |
            export TERM=xterm-256color
            bundle exec fastlane ios beta
          no_output_timeout: 30m

      # Update CircleCI CURRENT_VERSION environment variable
      - run:
          name: Update CircleCI Version Variable
          command: |
            # Read the new version written by Fastlane
            if [ ! -f .new_version ]; then
              echo "‚ö†Ô∏è  .new_version file not found - skipping version update"
              exit 0
            fi

            NEW_VERSION=$(cat .new_version)
            echo "üìù Updating CircleCI CURRENT_VERSION to: ${NEW_VERSION}"

            # Update environment variable via CircleCI API
            # First delete the old one
            curl -X DELETE \
              -H "Circle-Token: ${CIRCLECI_API_TOKEN}" \
              "https://circleci.com/api/v2/project/gh/Freegle/iznik-nuxt3/envvar/CURRENT_VERSION"

            # Then create new one with updated value
            curl -X POST \
              -H "Circle-Token: ${CIRCLECI_API_TOKEN}" \
              -H "Content-Type: application/json" \
              -d "{\"name\":\"CURRENT_VERSION\",\"value\":\"${NEW_VERSION}\"}" \
              "https://circleci.com/api/v2/project/gh/Freegle/iznik-nuxt3/envvar"

            echo "‚úÖ Updated CURRENT_VERSION to ${NEW_VERSION}"

      # Store build artifacts
      - store_artifacts:
          path: build/
          destination: ios-build

  # Build iOS for TestFlight from any branch (for testing)
  # Uses a test version number based on branch name hash
  build-ios-testflight:
    executor: macos-executor
    steps:
      - checkout

      # Install Node.js 22
      - run:
          name: Install Node.js 22
          command: |
            curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.39.0/install.sh | bash
            export NVM_DIR="$HOME/.nvm"
            [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"
            nvm install 22
            nvm use 22
            nvm alias default 22
            echo 'export NVM_DIR="$HOME/.nvm"' >> $BASH_ENV
            echo '[ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"' >> $BASH_ENV

      - run:
          name: Verify Node.js and npm versions
          command: |
            node --version
            npm --version

      - run:
          name: Install Node.js Dependencies
          command: |
            # First install all dependencies
            npm ci
            # Force update GitHub-hosted packages to latest (bypasses package-lock.json pinning)
            npm update @freegle/capacitor-push-notifications-cap7

      # Generate a test version number that's higher than any production version
      - run:
          name: Generate Test Version Number
          command: |
            # Use format 99.0.BUILD_NUM for test builds
            # Must be higher than production (currently 3.2.x) for App Store Connect
            # Using 99.x ensures test builds are always accepted
            TEST_VERSION="99.0.${CIRCLE_BUILD_NUM}"
            echo "üß™ Test version: $TEST_VERSION"
            echo "$TEST_VERSION" > .new_version

            # Update MOBILE_VERSION in config.js
            sed -i '' "s/MOBILE_VERSION: '[0-9]*\.[0-9]*\.[0-9]*'/MOBILE_VERSION: '$TEST_VERSION'/" config.js

            if grep -q "MOBILE_VERSION: '$TEST_VERSION'" config.js; then
              echo "‚úÖ Updated config.js with test version $TEST_VERSION"
              grep "MOBILE_VERSION:" config.js
            else
              echo "‚ùå ERROR: Failed to update config.js"
              exit 1
            fi

      - run:
          name: Build Nuxt App
          command: |
            export ISAPP=true
            export APP_ENV=production
            if [ -n "$SENTRY_DSN_APP_FD" ]; then
              export SENTRY_DSN="$SENTRY_DSN_APP_FD"
              echo "‚úÖ Using app-specific Sentry DSN"
            fi
            npm run generate

      - run:
          name: Sync Capacitor to iOS
          command: npx cap sync ios

      - run:
          name: Setup Firebase Configuration for iOS
          command: |
            if [ -n "$GOOGLE_SERVICE_INFO_PLIST_BASE64" ]; then
              echo "$GOOGLE_SERVICE_INFO_PLIST_BASE64" | base64 --decode > ios/App/App/GoogleService-Info.plist
              echo "‚úÖ GoogleService-Info.plist created"
            else
              echo "‚ùå GOOGLE_SERVICE_INFO_PLIST_BASE64 not set"
              exit 1
            fi

      - run:
          name: Install Fastlane
          command: |
            bundle config set --local path 'vendor/bundle'
            bundle update fastlane
            bundle install

      - run:
          name: Setup iOS Certificates
          command: |
            mkdir -p ~/certificates
            echo "$IOS_DISTRIBUTION_CERT" | base64 --decode > ~/certificates/ios_distribution.p12
            echo "$IOS_PROVISIONING_PROFILE" | base64 --decode > ~/certificates/ios_appstore.mobileprovision

            KEYCHAIN_PATH=~/Library/Keychains/temp.keychain-db
            KEYCHAIN_PASSWORD=circleci
            security delete-keychain "$KEYCHAIN_PATH" 2>/dev/null || true
            security create-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"
            security default-keychain -s "$KEYCHAIN_PATH"
            security unlock-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"
            security set-keychain-settings -t 3600 -u "$KEYCHAIN_PATH"

            echo "export IOS_CERTIFICATE_PATH=~/certificates/ios_distribution.p12" >> $BASH_ENV
            echo "export IOS_PROVISIONING_PROFILE_PATH=~/certificates/ios_appstore.mobileprovision" >> $BASH_ENV
            echo "export KEYCHAIN_NAME=$KEYCHAIN_PATH" >> $BASH_ENV
            echo "export KEYCHAIN_PASSWORD=$KEYCHAIN_PASSWORD" >> $BASH_ENV

      - run:
          name: Build and Deploy to TestFlight
          command: |
            export TERM=xterm-256color
            echo "üß™ Building TestFlight test version from branch: ${CIRCLE_BRANCH}"
            bundle exec fastlane ios beta
          no_output_timeout: 30m

      - run:
          name: TestFlight Build Complete
          command: |
            TEST_VERSION=$(cat .new_version)
            echo "üéâ TestFlight build complete!"
            echo ""
            echo "üì± Version: $TEST_VERSION"
            echo "üåø Branch: ${CIRCLE_BRANCH}"
            echo "üîó Commit: ${CIRCLE_SHA1:0:8}"
            echo ""
            echo "The build is now uploading to TestFlight."
            echo "It will be available for testing in ~15-30 minutes."

      - store_artifacts:
          path: build/
          destination: ios-build

workflows:
  version: 2

  build-android-dev-app:
    jobs:
      - build-android-dev-app:
          filters:
            branches:
              only:
                - master
                - /^feature\/.*$/

  pr-tests:
    jobs:
      - freegle/playwright-tests:
          filters:
            branches:
              ignore:
                - master
                - main
                - production
                - modtools

  deploy-apps:
    jobs:
      # First, increment the version (runs once)
      - increment-version:
          filters:
            branches:
              only:
                - production

      # Then build both Android and iOS in parallel (both use the same version)
      - build-android:
          requires:
            - increment-version
          filters:
            branches:
              only:
                - production

      - build-ios:
          requires:
            - increment-version
          filters:
            branches:
              only:
                - production

  auto-promote-schedule:
    triggers:
      - schedule:
          # Run at midnight UTC every day (24 hours after the 11pm merge)
          cron: "0 0 * * *"
          filters:
            branches:
              only:
                - production
    jobs:
      - auto-promote-production
      - auto-submit-ios
      - auto-release-ios

  manual-promote-submit:
    when: << pipeline.parameters.run_manual_promote >>
    jobs:
      - auto-promote-production:
          filters:
            branches:
              only:
                - production
      - auto-submit-ios:
          filters:
            branches:
              only:
                - production
      - auto-release-ios:
          filters:
            branches:
              only:
                - production

  # Build iOS for TestFlight from any branch
  # Trigger with: build_testflight=true parameter
  testflight-branch:
    when: << pipeline.parameters.build_testflight >>
    jobs:
      - build-ios-testflight
